
#include "base64.h"
#include <limits.h>
#include <string.h>

/* code taken for my own use from 
 * cvs.savannah.gnu.org/viewvc/gnulib/gnulib/lib/base64.c
 */

const char base64_alphabet[65] = {
   /* 000000 */ 'A',
   /* 000001 */ 'B',
   /* 000010 */ 'C',
   /* 000011 */ 'D',
   /* 000100 */ 'E',
   /* 000101 */ 'F',
   /* 000110 */ 'G',
   /* 000111 */ 'H',
   /* 001000 */ 'I',
   /* 001001 */ 'J',
   /* 001010 */ 'K',
   /* 001011 */ 'L',
   /* 001100 */ 'M',
   /* 001101 */ 'N',
   /* 001110 */ 'O',
   /* 001111 */ 'P',
   /* 010000 */ 'Q',
   /* 010001 */ 'R',
   /* 010010 */ 'S',
   /* 010011 */ 'T',
   /* 010100 */ 'U',
   /* 010101 */ 'V',
   /* 010110 */ 'W',
   /* 010111 */ 'X',
   /* 011000 */ 'Y',
   /* 011001 */ 'Z',
   /* 011010 */ 'a',
   /* 011011 */ 'b',
   /* 011100 */ 'c',
   /* 011101 */ 'd',
   /* 011110 */ 'e',
   /* 011111 */ 'f',
   /* 100000 */ 'g',
   /* 100001 */ 'h',
   /* 100010 */ 'i',
   /* 100011 */ 'j',
   /* 100100 */ 'k',
   /* 100101 */ 'l',
   /* 100110 */ 'm',
   /* 100111 */ 'n',
   /* 101000 */ 'o',
   /* 101001 */ 'p',
   /* 101010 */ 'q',
   /* 101011 */ 'r',
   /* 101100 */ 's',
   /* 101101 */ 't',
   /* 101110 */ 'u',
   /* 101111 */ 'v',
   /* 110000 */ 'w',
   /* 110001 */ 'x',
   /* 110010 */ 'y',
   /* 110011 */ 'z',
   /* 110100 */ '0',
   /* 110101 */ '1',
   /* 110110 */ '2',
   /* 110111 */ '3',
   /* 111000 */ '4',
   /* 111001 */ '5',
   /* 111010 */ '6',
   /* 111011 */ '7',
   /* 111100 */ '8',
   /* 111101 */ '9',
   /* 111110 */ '+',
   /* 111111 */ '/',
   /* pad    */ '=',
};

const char base64url_alphabet[65] = {
   /* 000000 */ 'A',
   /* 000001 */ 'B',
   /* 000010 */ 'C',
   /* 000011 */ 'D',
   /* 000100 */ 'E',
   /* 000101 */ 'F',
   /* 000110 */ 'G',
   /* 000111 */ 'H',
   /* 001000 */ 'I',
   /* 001001 */ 'J',
   /* 001010 */ 'K',
   /* 001011 */ 'L',
   /* 001100 */ 'M',
   /* 001101 */ 'N',
   /* 001110 */ 'O',
   /* 001111 */ 'P',
   /* 010000 */ 'Q',
   /* 010001 */ 'R',
   /* 010010 */ 'S',
   /* 010011 */ 'T',
   /* 010100 */ 'U',
   /* 010101 */ 'V',
   /* 010110 */ 'W',
   /* 010111 */ 'X',
   /* 011000 */ 'Y',
   /* 011001 */ 'Z',
   /* 011010 */ 'a',
   /* 011011 */ 'b',
   /* 011100 */ 'c',
   /* 011101 */ 'd',
   /* 011110 */ 'e',
   /* 011111 */ 'f',
   /* 100000 */ 'g',
   /* 100001 */ 'h',
   /* 100010 */ 'i',
   /* 100011 */ 'j',
   /* 100100 */ 'k',
   /* 100101 */ 'l',
   /* 100110 */ 'm',
   /* 100111 */ 'n',
   /* 101000 */ 'o',
   /* 101001 */ 'p',
   /* 101010 */ 'q',
   /* 101011 */ 'r',
   /* 101100 */ 's',
   /* 101101 */ 't',
   /* 101110 */ 'u',
   /* 101111 */ 'v',
   /* 110000 */ 'w',
   /* 110001 */ 'x',
   /* 110010 */ 'y',
   /* 110011 */ 'z',
   /* 110100 */ '0',
   /* 110101 */ '1',
   /* 110110 */ '2',
   /* 110111 */ '3',
   /* 111000 */ '4',
   /* 111001 */ '5',
   /* 111010 */ '6',
   /* 111011 */ '7',
   /* 111100 */ '8',
   /* 111101 */ '9',
   /* 111110 */ '-',
   /* 111111 */ '_',
   /* pad    */ '=',
};

const char base32_alphabet[33] = {
   /* 00000 */ 'A',
   /* 00001 */ 'B',
   /* 00010 */ 'C',
   /* 00011 */ 'D',
   /* 00100 */ 'E',
   /* 00101 */ 'F',
   /* 00110 */ 'G',
   /* 00111 */ 'H',
   /* 01000 */ 'I',
   /* 01001 */ 'J',
   /* 01010 */ 'K',
   /* 01011 */ 'L',
   /* 01100 */ 'M',
   /* 01101 */ 'N',
   /* 01110 */ 'O',
   /* 01111 */ 'P',
   /* 10000 */ 'Q',
   /* 10001 */ 'R',
   /* 10010 */ 'S',
   /* 10011 */ 'T',
   /* 10100 */ 'U',
   /* 10101 */ 'V',
   /* 10110 */ 'W',
   /* 10111 */ 'X',
   /* 11000 */ 'Y',
   /* 11001 */ 'Z',
   /* 11010 */ '2',
   /* 11011 */ '3',
   /* 11100 */ '4',
   /* 11101 */ '5',
   /* 11110 */ '6',
   /* 11111 */ '7',
   /* pad   */ '=',
};

const char base32hex_alphabet[33] = {
   /* 00000 */ '0',
   /* 00001 */ '1',
   /* 00010 */ '2',
   /* 00011 */ '3',
   /* 00100 */ '4',
   /* 00101 */ '5',
   /* 00110 */ '6',
   /* 00111 */ '7',
   /* 01000 */ '8',
   /* 01001 */ '9',
   /* 01010 */ 'A',
   /* 01011 */ 'B',
   /* 01100 */ 'C',
   /* 01101 */ 'D',
   /* 01110 */ 'E',
   /* 01111 */ 'F',
   /* 10000 */ 'G',
   /* 10001 */ 'H',
   /* 10010 */ 'I',
   /* 10011 */ 'J',
   /* 10100 */ 'K',
   /* 10101 */ 'L',
   /* 10110 */ 'M',
   /* 10111 */ 'N',
   /* 11000 */ 'O',
   /* 11001 */ 'P',
   /* 11010 */ 'Q',
   /* 11011 */ 'R',
   /* 11100 */ 'S',
   /* 11101 */ 'T',
   /* 11110 */ 'U',
   /* 11111 */ 'V',
   /* pad   */ '=',
};

const char base16_alphabet[17] = {
   /* 0000 */ '0',
   /* 0001 */ '1',
   /* 0010 */ '2',
   /* 0011 */ '3',
   /* 0100 */ '4',
   /* 0101 */ '5',
   /* 0110 */ '6',
   /* 0111 */ '7',
   /* 1000 */ '8',
   /* 1001 */ '9',
   /* 1010 */ 'A',
   /* 1011 */ 'B',
   /* 1100 */ 'C',
   /* 1101 */ 'D',
   /* 1110 */ 'E',
   /* 1111 */ 'F',
   /* pad  */ '=',
};

int base64_to(char * dest, uint8_t * src, size_t nmemb) {

   char * start = dest;

   while (nmemb) {

      *dest++ = base64_alphabet[ (src[0] >> 2) & 0x3f ];
      *dest++ = base64_alphabet[ ((src[0] << 4) + (--nmemb ? src[1] >> 4 : 0)) & 0x3f ];
      *dest++ = (nmemb ? base64_alphabet[ ((src[1] << 2) + (--nmemb ? src[2] >> 6 : 0)) & 0x3f ] : '=');
      *dest++ = nmemb ? base64_alphabet[ src[2] & 0x3f] : '=';

      if (nmemb)
         --nmemb;

      if (nmemb)
         src += 3;
   }

   *dest = '\0';

   return dest - start;
}

int base64_to_alphabet(char * dest, uint8_t * src, size_t nmemb, const char * alphabet) {

   char * start = dest;

   while (nmemb) {

      *dest++ = alphabet[ (src[0] >> 2) & 0x3f ];
      *dest++ = alphabet[ ((src[0] << 4) + (--nmemb ? src[1] >> 4 : 0)) & 0x3f ];
      *dest++ = (nmemb ? alphabet[ ((src[1] << 2) + (--nmemb ? src[2] >> 6 : 0)) & 0x3f ] : '=');
      *dest++ = nmemb ? alphabet[ src[2] & 0x3f] : '=';

      if (nmemb)
         --nmemb;

      if (nmemb)
         src += 3;
   }

   *dest = '\0';

   return dest - start;
}

int base64_from(uint8_t * dest, char * src, size_t nmemb) {

   uint8_t * start = dest;

   static const uint8_t revb64[UCHAR_MAX+1] = {
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /*   0 -  11 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /*  12 -  23 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /*  24 -  35 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1, 0x3e,   -1,   -1,   -1, 0x3f, /*  36 -  47 */
     0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d,   -1,   -1, /*  48 -  59 */
       -1,   -1,   -1,   -1,   -1, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, /*  60 -  71 */
     0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, /*  72 -  83 */
     0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,   -1,   -1,   -1,   -1,   -1, /*  84 -  95 */
       -1, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, /*  96 - 107 */
     0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, /* 108 - 119 */
     0x31, 0x32, 0x33,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 120 - 131 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 132 - 143 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 144 - 155 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 156 - 167 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 168 - 179 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 180 - 191 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 192 - 203 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 204 - 215 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 216 - 227 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 228 - 239 */
       -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1,   -1, /* 240 - 251 */
       -1,   -1,   -1,   -1                                                  /* 252 - 255 */
   };

   while (nmemb >= 2) {

      if (revb64[src[0]] == 0xff || revb64[src[1]] == 0xff)
         break;

      *dest++ = ((revb64[src[0]] << 2) | (revb64[src[1]] >> 4));

      if (nmemb == 2)
         break;

      if (src[2] == '=') {
         if (nmemb != 4)
            break;
         if (src[3] != '=')
            break;
      }
      else {

         if (revb64[src[2]] == 0xff)
            break;

         *dest++ = (((revb64[src[1]] << 4) & 0xf0) | (revb64[src[2]] >> 2));

         if (nmemb == 3)
            break;

         if (src[3] == '=') {

            if (nmemb != 4)
               break;
         }
         else {

            if (revb64[src[3]] == 0xff)
                  break;

            *dest++ = (((revb64[src[2]] << 6) &0xc0) | (revb64[src[3]]));

         }
      }

      src += 4;
      nmemb -= 4;

   }

   return dest - start;
}

int base64_from_alphabet(uint8_t * dest, char * src, size_t nmemb, const char * alphabet) {

   uint8_t * start = dest;

   uint8_t revb64[UCHAR_MAX+1];
   memset(revb64,0xff,UCHAR_MAX+1);

   /* load in the alphabet */
   for (uint8_t i = 0; i < 65; ++i)
      revb64[alphabet[i]] = i;

   while (nmemb >= 2) {

      if (revb64[src[0]] == 0xff || revb64[src[1]] == 0xff)
         break;

      *dest++ = ((revb64[src[0]] << 2) | (revb64[src[1]] >> 4));

      if (nmemb == 2)
         break;

      if (src[2] == '=') {
         if (nmemb != 4)
            break;
         if (src[3] != '=')
            break;
      }
      else {

         if (revb64[src[2]] == 0xff)
            break;

         *dest++ = (((revb64[src[1]] << 4) & 0xf0) | (revb64[src[2]] >> 2));

         if (nmemb == 3)
            break;

         if (src[3] == '=') {

            if (nmemb != 4)
               break;
         }
         else {

            if (revb64[src[3]] == 0xff)
                  break;

            *dest++ = (((revb64[src[2]] << 6) &0xc0) | (revb64[src[3]]));

         }
      }

      src += 4;
      nmemb -= 4;

   }

   return dest - start;
}

